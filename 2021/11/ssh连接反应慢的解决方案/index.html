<!doctype html><head><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><title>ssh连接反应慢的解决方案 - Chireiden</title><meta name=author content="RedContritio"><meta name=description content="地霊殿，充满幻想与希望的殿堂"><meta name=keywords content="ssh,sshd,服务器,网络"><meta property="og:title" content="ssh连接反应慢的解决方案"><meta property="og:description" content="发现问题
最近几次走 ssh 连接树莓派的时候，经常会发生连接速度较慢的问题，表现为每次按键后需要几秒时间才能反应过来，甚至直接断开连接，例如局域网ssh延迟这篇中所述的情况。"><meta property="og:type" content="article"><meta property="og:url" content="https://RedContritio.github.io/2021/11/ssh%E8%BF%9E%E6%8E%A5%E5%8F%8D%E5%BA%94%E6%85%A2%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-05T15:53:31+00:00"><meta property="article:modified_time" content="2021-11-05T15:53:31+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ssh连接反应慢的解决方案"><meta name=twitter:description content="发现问题
最近几次走 ssh 连接树莓派的时候，经常会发生连接速度较慢的问题，表现为每次按键后需要几秒时间才能反应过来，甚至直接断开连接，例如局域网ssh延迟这篇中所述的情况。"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqusjs.css><link rel=stylesheet href=https://RedContritio.github.io/scss/main.min.b9b6b671bc2491131397b1a73b759d56a490f3a33abd09ce6fcb946e58f9526a.css integrity="sha256-uba2cbwkkRMTl7GnO3WdVqSQ86M6vQnOb8uUblj5Umo=" crossorigin=anonymous media=screen><link href=//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css rel=stylesheet></head></head><body><span class="mobile btn-mobile-menu"><i class="fa fa-list btn-mobile-menu__icon"></i>
<i class="fa fa-angle-up btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed" style=background-image:url(/images/background-cover.jpg)><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><a href=/#blog title="Homepage of Chireiden " class=blog-button><img src=/images/avatar.jpg width=80 alt="Chireiden logo" class="panel-cover__logo logo"></a><h1 class="panel-cover__title panel-title"><a href=/#blog title="Homepage of Chireiden" class=blog-button>Chireiden</a></h1><span class="panel-cover__subtitle panel-subtitle">地霊殿</span><hr class=panel-cover__divider><p class=panel-cover__description>地霊殿，充满幻想与希望的殿堂</p><hr class="panel-cover__divider panel-cover__divider--secondary"><p class=panel-cover__description>夢も希望も無い、毎日がそんな生活だった。</p><div class=navigation-wrapper><div><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=/#blog title=Blog class=blog-button>Blog</a></li><li class=navigation__item><a href=/about/ target=_blank title=About>About</a></li><li class=navigation__item><a href=/friend/ target=_blank title=Friend>Friend</a></li><li class=navigation__item><a href=/tags/ target=_blank title=Tags>Tags</a></li></ul></nav></div><div><nav class="cover-navigation navigation--social"><ul class=navigation><li class=navigation__item><a href=https://github.com/RedContritio title=@RedContritio target=_blank><i class='social fa fa-github'></i>
<span class=label>Github</span></a></li><li class=navigation__item><a href=/index.xml rel=author title=RSS target=_blank><i class='social fa fa-rss'></i>
<span class=label>RSS</span></a></li><li class=navigation__item><a href=mailto:RedContritio@qq.com title="Contact me"><i class='social fa fa-envelope'></i>
<span class=label>Email</span></a></li></ul></nav></div></div></div></div><div class="panel-cover--overlay cover-light-red"></div></div></header><div class=content-wrapper><div class=content-wrapper__inner><article class="post-container post-container--single" itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><div class=post-meta><time datetime=" 2021-11-05 15:53:31 +0000 " itemprop=datePublished class="post-meta__date date">2021-11-05</time>
<span class="post-meta__tags tags">• <a href=https://RedContritio.github.io/tags/ssh>ssh</a> • <a href=https://RedContritio.github.io/tags/sshd>sshd</a> • <a href=https://RedContritio.github.io/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8>服务器</a> • <a href=https://RedContritio.github.io/tags/%E7%BD%91%E7%BB%9C>网络</a></span></div><h1 class=post-title>ssh连接反应慢的解决方案</h1></header><section class=post><h2 id=发现问题>发现问题</h2><p>最近几次走 ssh 连接树莓派的时候，经常会发生连接速度较慢的问题，表现为每次按键后需要几秒时间才能反应过来，甚至直接断开连接，例如<a href=https://serverfault.com/questions/961576/ssh-lag-in-lan-on-some-machines-mixed-distros>局域网ssh延迟</a>这篇中所述的情况。</p><p>在发生延迟后，对树莓派ip进行一个的ping，然后，嘿嘿，ping炸了。</p><p>简单来说，ping 的时候，丢包率达到了<em><strong>喜人的 87%</strong></em> 以上。</p><p>哇，那怎么会这么高呢？</p><p>通过直接在树莓派上操作，网络什么也都正常。</p><p>唔，所以大致是 ping 不稳定，导致的 ssh 连接不稳？</p><h2 id=定位问题>定位问题</h2><p>首先，在<a href=https://www.annhe.net/article-4504.html>网上</a>看到了一个有趣的关键词：</p><p><strong>高效能以太网</strong></p><blockquote><p>高能效以太网（英语：Energy-Efficient Ethernet，简称EEE）是一套对双绞线与计算机网络标准之以太网家族的背板的增强，使其在低数据活动期间消耗较少的功率。</p><p>其目标是将功耗降低50%以上，同时保持与现有设备的完全兼容。</p><p>它的功率降低以几种方式实现。在100 Mbit/s、1吉比特和10 Gbit/s速度的数据链路中，物理层发送器会始终使用能量。</p><p>在没有数据发送时，它们可以进入“睡眠”模式以节约能源。
当控制器软件或固件确定不需要发送数据时，它可以发出一条“低功耗闲置”（LPI）请求到以太网控制器的物理层PHY。PHY然后将LPI信号在特定时间发送到链路上，以及禁用发送器。</p><p>信号刷新将周期性地发送以维持链路信令的完整性。当需要发送数据时，将在预定时间段发送IDLE信号。
数据链路可以被视为始终在运行，因为即使发送路径处在睡眠模式，接收信号的电路仍保持活跃。</p></blockquote><p>综上所述，可以看出，<strong>EEE会采用降低发送频率的方式节能</strong>。</p><p>执行该命令，查看是否启用了 EEE。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ethtool --show-eee eth0
</span></span></code></pre></div><p>通过观察可以看到，输出中，有</p><blockquote><p>EEE status: enabled - active</p></blockquote><p>因此判断出，问题出现在 EEE 上。</p><h2 id=解决问题>解决问题</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ethtool --set-eee eth0 eee off
</span></span></code></pre></div><p>执行后再次检查 EEE 状态，可以看到其已关闭（disabled）。</p><p>为了保险，进行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo service sshd restart
</span></span></code></pre></div><p>从而解决问题，丝滑 ssh。</p><h2 id=长期配置>长期配置</h2><p>可以将其加入开机启动项中，例如在 Raspberry 4B 上，可以将命令加入到 <code>/etc/rc.local</code> 中。</p><p>加入的命令如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ethtool --set-eee eth0 eee off
</span></span></code></pre></div></section></article><section class=read-more><div class=read-more-header><div class="read-more-header-item read-more-item"><span class=read-more-item-dim>Recent</span><h2 class="post-list__post-title post-title"><a href=/2021/11/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%B5%84%E8%B4%A8%E5%B9%B3%E5%B9%B3%E4%B9%9F%E8%A6%81%E5%AF%BB%E4%BB%99%E9%97%AE%E9%81%93/ title="link to 编程通解 第一章 资质平平也要寻仙问道">编程通解 第一章 资质平平也要寻仙问道</a></h2></div><div class="read-more-header-item read-more-item"><span class=read-more-item-dim>Earlier</span><h2 class="post-list__post-title post-title"><a href=/2020/01/%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B/ title="link to 阿里云服务器基础配置过程">阿里云服务器基础配置过程</a></h2></div></div><div class=read-more-summary><div class="read-more-summary-item read-more-item"><p class=excerpt><p>竹林里站着一个孩子，十来岁的孩子。</p><p>他什么也没做，只是站着，盯着竹子，满脸的愤懑。</p><p>他所在的竹林在陈家后山上，外人不得入内，所以，他自然也是陈家的人。</p><p>可惜，他的七品资质，在寻常人家里，能让邻里人前人后议论数月不止的七品资质，却让他快要做不了陈家的人了。</p>&mldr;</p></div><div class="read-more-summary-item read-more-item"><p class=excerpt><p>由于某些不可言说、无法理解的原因，我今天早上 00:00 的时候租了阿里云的轻量级服务器。</p><p>因为要配置相关环境，尤其指 Python 大礼包和 Anaconda（及 pyTorch），并且在过程中踩了很多坑，在其稍作记录。</p>&mldr;</p></div></div><div class=read-more-meta><div class="read-more-meta-item read-more-item"><time datetime="2021-11-05 15:53:31 +0000" class="post-list__meta--date date">2021-11-12</time>
<span class="post-list__meta--tags tags">• <a href=https://RedContritio.github.io/tags/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3>编程通解</a> • <a href=https://RedContritio.github.io/tags/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3>编程思想</a> • <a href=https://RedContritio.github.io/tags/%E5%B0%8F%E8%AF%B4>小说</a></span>
<a class=btn-border-small href=/2021/11/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%B5%84%E8%B4%A8%E5%B9%B3%E5%B9%B3%E4%B9%9F%E8%A6%81%E5%AF%BB%E4%BB%99%E9%97%AE%E9%81%93/>Continue</a></div><div class="read-more-meta-item read-more-item"><time datetime="2021-11-05 15:53:31 +0000" class="post-list__meta--date date">2020-01-14</time>
<span class="post-list__meta--tags tags">• <a href=https://RedContritio.github.io/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8>服务器</a> • <a href=https://RedContritio.github.io/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE>环境配置</a> • <a href=https://RedContritio.github.io/tags/centos>centOS</a></span>
<a class=btn-border-small href=/2020/01/%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B/>Continue</a></div></div></section><section class=post-comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://RedContritio.github.io/2021/11/ssh%E8%BF%9E%E6%8E%A5%E5%8F%8D%E5%BA%94%E6%85%A2%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",this.page.identifier="https://RedContritio.github.io/2021/11/ssh%E8%BF%9E%E6%8E%A5%E5%8F%8D%E5%BA%94%E6%85%A2%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"},disqus_shortname="vno-hugo";(function(){var e=document,t=e.createElement("script");t.src="//"+disqus_shortname+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>To view comments from<a href=http://disqus.com/?ref_noscript> Disqus </a>, please enable JavaScript.</noscript></section><section class=footer><footer><span class=footer__copyright>This site is licensed under a <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> license.</span>
<span class=footer__copyright>Generated by <a href=https://gohugo.io/>Hugo</a> at 2023-03-26, themed with <a href=https://github.com/xslingcn/vno-hugo>Vno - Hugo</a>.</span></footer></section></div></div><script type=text/javascript src=//code.jquery.com/jquery-1.11.3.min.js></script>
<script type=text/javascript src=/js/main.js></script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","your_ga_id","your_host"),ga("send","pageview")</script></body>