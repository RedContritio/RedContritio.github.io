<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>matplotlib编码字体错误的解决过程 - Chireiden</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="发现问题众所周知，设置 matplotlib 输出中文需要： plt.rcParams[‘font.sans-serif’]&#x3D;[‘SimHei’]  # 用来正常显示中文标签plt.rcParams[‘axes.unicode_minus’]&#x3D;False  # 用来正常显示负号">
<meta property="og:type" content="article">
<meta property="og:title" content="matplotlib编码字体错误的解决过程">
<meta property="og:url" content="https://redcontritio.github.io/2019/11/07/matplotlib%E7%BC%96%E7%A0%81%E5%AD%97%E4%BD%93%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="Chireiden">
<meta property="og:description" content="发现问题众所周知，设置 matplotlib 输出中文需要： plt.rcParams[‘font.sans-serif’]&#x3D;[‘SimHei’]  # 用来正常显示中文标签plt.rcParams[‘axes.unicode_minus’]&#x3D;False  # 用来正常显示负号">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-06T16:11:02.000Z">
<meta property="article:modified_time" content="2023-02-07T14:13:59.719Z">
<meta property="article:author" content="RedContritio">
<meta property="article:tag" content="python matplotlib">
<meta name="twitter:card" content="summary">
    
<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/justifiedGallery/justifiedGallery.min.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1675841852990">
    
    <link rel="stylesheet" href="/css/style.css?v=1675841852990">
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/custom_css_source.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="chireiden-background">
        <div class="chireiden-bg" style="background-image: url(/resources/Jupiter.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon chireidenfont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="RedContritio" class="mdui-btn mdui-btn-icon"><img src="https://avatars.githubusercontent.com/u/25874478?v=4" alt="RedContritio"></a>
            </div>
        </div>
    </div>
    <div id="chireiden-header">
        <div class="chireiden-drawer mdui-drawer" id="drawer">
    <div class="chireiden-avatar mdui-ripple">
        <a href="/" title="RedContritio">
            <img src="https://avatars.githubusercontent.com/u/25874478?v=4" alt="RedContritio" alt="RedContritio">
        </a>
    </div>
    <div class="chireiden-count">
        <div><span>文章</span>12</div>
        <div><span>标签</span>9</div>
        <div><span>分类</span>0</div>
    </div>
    <div class="chireiden-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="chireiden-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon chireidenfont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="chireiden-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon chireidenfont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="chireiden-list-item mdui-list-item mdui-ripple false" href="/friend.html" title="我的朋友">
            <i class="mdui-list-item-icon chireidenfont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="chireiden-sidebar">
    
    <div class="chireiden-widget-wrap">
    <div class="chireiden-widget chireiden-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="chireiden-widget-wrap">
    <div class="chireiden-widget chireiden-social">
        <a class="mdui-ripple" href="https://jq.qq.com/?_wv=1027&k=5CfKHun" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="chireidenfont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/20238211" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="chireidenfont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/nexmoe/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="chireidenfont icon-github"></i>
        </a>
    </div>
</div>
    
    

    
    
  <div class="chireiden-widget-wrap">
    <div id="randomtagcloud" class="chireiden-widget tagcloud chireiden-rainbow">
      <a href="/tags/Everything-%E6%B8%B8%E6%88%8F/" style="font-size: 10px;">Everything 游戏</a> <a href="/tags/VS-CSharp-Mods-Environment/" style="font-size: 10px;">VS CSharp Mods Environment</a> <a href="/tags/python-matplotlib/" style="font-size: 10px;">python matplotlib</a> <a href="/tags/ssh-sshd-%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">ssh sshd 服务器 网络</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-centOS/" style="font-size: 10px;">服务器 环境配置 centOS</a> <a href="/tags/%E7%A4%BE%E5%9B%A2%E8%AF%BE%E7%A8%8B/" style="font-size: 15px;">社团课程</a> <a href="/tags/%E7%A4%BE%E5%9B%A2%E8%AF%BE%E7%A8%8B-%E9%9B%B6%E5%9F%BA%E7%A1%80%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">社团课程 零基础课程</a> <a href="/tags/%E7%BB%B4%E6%8A%A4/" style="font-size: 20px;">维护</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3-%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3-%E5%B0%8F%E8%AF%B4/" style="font-size: 10px;">编程通解 编程思想 小说</a>
    </div>
    
  </div>

    
    <!-- 一言 -->

  <div class="chireiden-widget-wrap">
    <h3 class="chireiden-widget-title">
      一言
    </h3>
    <div class="chireiden-widget">
      <ul class="hitokoto-box">
        <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
          <a href="#" id="hitokoto_text">
            
          </a>
          <a href="#" id="hitokoto_error_text" style="display: none;">
            
          </a>
        </li>
      </ul>
    </div>
  </div>

  <script>
    let hitokotoText = document.getElementById('hitokoto_text')
    let hitokotoErroText = document.getElementById('hitokoto_error_text')
    let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
    window.onload = function () {
      let url = 'https://v1.hitokoto.cn'
      if (hitokotoCategory) {
        url += '?c=' + hitokotoCategory
      }
      fetch(url)
        .then(response => response.json())
        .then(data => {
          hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
          hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
        })
        .catch((reason) => {
          console.error(11, reason)
          hitokotoText.style.display = 'none'
          hitokotoErroText.style.display = 'block'
        })
    }
  </script>
  
    
</aside>
    <div class="chireiden-copyright">
        &copy; 2023 RedContritio
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-chireiden/hexo-theme-chireiden" target="_blank">Chireiden</a>
        <br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .chireiden-drawer -->
    </div>
    <div id="chireiden-content">
        <div class="chireiden-primary">
            <div class="chireiden-post">

  <article>
      
          <div class="chireiden-post-cover" style="padding-bottom: NaN%;"> 
              <img src="https://tva2.sinaimg.cn/large/9bd9b167gy1fwrteef8x2j21hc0u0ql4.jpg" alt="matplotlib编码字体错误的解决过程" loading="lazy">
              <h1>matplotlib编码字体错误的解决过程</h1>
          </div>
      
      
      <div class="chireiden-post-meta chireiden-rainbow" style="margin:10px 0!important;">
    <a><i class="chireidenfont icon-calendar-fill"></i>2019年11月07日</a>
</div>

      <div class="chireiden-post-meta chireiden-rainbow" style="margin:10px 0!important;">
    
        <a><i class="chireidenfont icon-areachart"></i>约2.6k字</a>
        <a><i class="chireidenfont icon-time-circle-fill"></i>预计需要13分钟</a>
    
</div>

      <h2 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h2><p>众所周知，设置 matplotlib 输出中文需要：</p>
<p>plt.rcParams[‘font.sans-serif’]&#x3D;[‘SimHei’]  # 用来正常显示中文标签<br>plt.rcParams[‘axes.unicode_minus’]&#x3D;False  # 用来正常显示负号</p>
<span id="more"></span>

<p>第一行是设置字体（推荐使用 <code>.insert(0, fontname)</code> 而非直接赋值）</p>
<p>第二行则是设置减号（<code>-</code> ）采用 ASCII 码查找字体，而非 unicode 编码。</p>
<p>但是，在使用过程中发生了错误。</p>
<p>复现错误：</p>
<pre><code class="python"># -*- coding: UTF-8 -*-
%matplotlib inline

import matplotlib.pyplot as plt

plt.rcParams[&#39;font.sans-serif&#39;]=[&#39;SimHei&#39;]
plt.rcParams[&#39;axes.unicode_minus&#39;]=False



plt.figure(figsize=(18,9))

data = [0.001*(10**i) for i in range(4)]
bins = 10**(np.linspace(-3, 2))
plt.hist(data, bins = bins, label = &#39;test&#39;)

plt.xscale(&#39;log&#39;)
plt.ylabel(&#39;English test&#39;)
plt.title(&#39;汉字测试&#39;)

plt.show()
</code></pre>
<p>会发生这样的错误：</p>
<blockquote>
<pre><code>%pythonlib%\matplotlib\mathtext.py:849: MathTextWarning: Font &#39;default&#39; does not have a glyph for &#39;-&#39; [U+2212]
  MathTextWarning)
%pythonlib%\matplotlib\mathtext.py:850: MathTextWarning: Substituting with a dummy symbol.
  warn(&quot;Substituting with a dummy symbol.&quot;, MathTextWarning)
</code></pre>
</blockquote>
<p>我们可以认为是 ‘-‘ 导致的出错。</p>
<p>通过在 github 上的 <a target="_blank" rel="noopener" href="https://github.com/matplotlib/matplotlib">matplotlib 项目</a> 查找，可以找到这个文件 <a target="_blank" rel="noopener" href="https://github.com/matplotlib/matplotlib/blob/master/examples/text_labels_and_annotations/unicode_minus.py">matplotlib&#x2F;examples&#x2F;text_labels_and_annotations&#x2F;unicode_minus.py</a> ，通过看文件名，大致可知其为 <code>unicode_minus</code> 的示例文件。</p>
<p>内容如下：</p>
<pre><code class="python">&quot;&quot;&quot;
=============
Unicode minus
=============
By default, tick labels at negative values are rendered using a `Unicode
minus`__ (U+2212) rather than an ASCII hyphen (U+002D).  This can be controlled
by setting :rc:`axes.unicode_minus`.
__ https://en.wikipedia.org/wiki/Plus_and_minus_signs#Character_codes
The replacement is performed at draw time of the tick labels (usually during a
`.pyplot.show()` or `.pyplot.savefig()` call). Therefore, all tick labels of
the figure follow the same setting and we cannot demonstrate both glyphs on
real tick labels of the same figure simultaneously.
Instead, this example simply showcases the difference between the two glyphs
in a magnified font.
&quot;&quot;&quot;

import matplotlib.pyplot as plt

fig = plt.figure(figsize=(4, 2))
fig.text(.15, .6, &quot;Unicode minus:&quot;, fontsize=20)
fig.text(.85, .6, &quot;\N&#123;MINUS SIGN&#125;1&quot;, ha=&#39;right&#39;, fontsize=20)
fig.text(.15, .3, &quot;ASCII hyphen:&quot;, fontsize=20)
fig.text(.85, .3, &quot;-1&quot;, ha=&#39;right&#39;, fontsize=20)
plt.show()
</code></pre>
<p>可知，<code>unicode_minus</code> 设置为 <code>False</code> 时，理应不使用 U+2212 输出，而是使用 U+002D，然而上面的错误信息却试图输出 U+2212，我们可以认为是这个选项没有起到作用。</p>
<h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><p>通过注释，我们可以发现出现警告的原因是<code>plt.xscale(&#39;log&#39;)</code> 一行。</p>
<p>不妨在库源码中追溯来源。</p>
<pre><code class="python">import matplotlib.pyplot as plt
</code></pre>
<p>由此可知，错误是在 <code>matplotlib.pyplot.xscale</code> 调用时出现的。</p>
<p>追溯<code>matplotlib.pyplot.xscale</code> 可得：</p>
<pre><code class="python">def xscale(*args, **kwargs):
    gca().set_xscale(*args, **kwargs)
</code></pre>
<p>首先判断 <code>gca()</code> 类型，由 <code>print(gca().__module__)</code> 输出 <code>matplotlib.axes._subplots</code> 。</p>
<p>打开对应模块，会发现找不到 <code>gca()</code> 的定义。</p>
<p>改为 <code>print(type(gca()))</code> ，输出<code>&lt;class &#39;matplotlib.axes._subplots.AxesSubplot&#39;&gt;</code> 。</p>
<p>虽然未能找到 <code>AxesSubplot</code> ，但是观察可得，<code>AxesSubplot</code> 应该是 <code>matplotlib.axes._subplots.SubplotBase</code>  的一个子类&#x2F;别名。</p>
<p>然而，在该基类中未能找到对应的函数。</p>
<p>由于 python 具有反射机制，我们想当然地去<code>matplotlib\axes\_base.py</code> 中，在<code>matplotlib.axes._base._AxesBase</code> 内，可以找到</p>
<pre><code class="python">    def set_xscale(self, value, **kwargs):
        g = self.get_shared_x_axes()
        for ax in g.get_siblings(self):
            ax.xaxis._set_scale(value, **kwargs)
            ax._update_transScale()
            ax.stale = True

        self.autoscale_view(scaley=False)
</code></pre>
<p>简单分析可知，我们出错的情况下， <code>set_xscale</code> 传入参数为 <code>set_xscale(this, &#39;log&#39;)</code> 。</p>
<p>也即通过该函数呈递给  <code>ax.xaxis._set_scale(value, **kwargs)</code> ，此时<code>value = &#39;log&#39;, kwargs=&#123;&#125;</code> 。</p>
<p>在呈递前插入</p>
<pre><code class="python">            print(type(ax.xaxis))
</code></pre>
<p>得到输出<code>&lt;class &#39;matplotlib.axis.XAxis&#39;&gt;</code> 。</p>
<p>由于<code>XAxis</code> 继承于<code>Axis</code> ，搜索<code>_set_scale</code> 可发现其定义于后者，即基类中。</p>
<pre><code class="python">    def _set_scale(self, value, **kwargs):
        self._scale = mscale.scale_factory(value, self, **kwargs)
        self._scale.set_default_locators_and_formatters(self)

        self.isDefault_majloc = True
        self.isDefault_minloc = True
        self.isDefault_majfmt = True
        self.isDefault_minfmt = True
</code></pre>
<p>通过尝试输出<code>self._scale</code> ，可以得到缩放类型为<code>&quot;log&quot;</code> 时，该变量类型为<code>matplotlib.scale.LogScale</code> 。</p>
<p>目前，我们可以得到这样的呈递关系图：</p>
<pre class="mermaid">graph TB;
    plt-->gca;
    gca-->axis;
    axis-->mscale;
    
plt[pyplot.xscale&#40'log'&#41]
gca[axes._subplots.set_xscale&#40'log'&#41]
axis[axis.XAxis._set_scale&#40'log'&#41]
mscale[scale.LogScale.set_default_locators_and_formatters&#40&#41]</pre>

<p>根据</p>
<pre><code class="python">class LogitScale(ScaleBase):
    ...
</code></pre>
<pre><code class="python">_scale_mapping = &#123;
    &#39;linear&#39;: LinearScale,
    &#39;log&#39;:    LogScale,
    &#39;symlog&#39;: SymmetricalLogScale,
    &#39;logit&#39;:  LogitScale,
    &#125;
</code></pre>
<pre><code class="python">def scale_factory(scale, axis, **kwargs):
    &quot;&quot;&quot;
    Return a scale class by name.

    ACCEPTS: [ %(names)s ]
    &quot;&quot;&quot;
    scale = scale.lower()
    if scale is None:
        scale = &#39;linear&#39;

    if scale not in _scale_mapping:
        raise ValueError(&quot;Unknown scale type &#39;%s&#39;&quot; % scale)

    return _scale_mapping[scale](axis, **kwargs)
scale_factory.__doc__ = cbook.dedent(scale_factory.__doc__) % \
    &#123;&#39;names&#39;: &quot; | &quot;.join(get_scale_names())&#125;
</code></pre>
<p>可得<code>self._scale = mscale.scale_factory(&#39;log&#39;)</code> 等价于<code>self._scale = mscale.LogScale(self)</code> 。</p>
<p>到 <code>class &#39;matplotlib.scale.LogScale&#39;</code> 中可以看到方法</p>
<pre><code class="python">    def set_default_locators_and_formatters(self, axis):
        &quot;&quot;&quot;
        Set the locators and formatters to specialized versions for
        log scaling.
        &quot;&quot;&quot;
        axis.set_major_locator(LogLocator(self.base))
        axis.set_major_formatter(LogFormatterSciNotation(self.base))
        axis.set_minor_locator(LogLocator(self.base, self.subs))
        axis.set_minor_formatter(
            LogFormatterSciNotation(self.base,
                                    labelOnlyBase=(self.subs is not None)))
</code></pre>
<p>观察易知，其分别设置刻度的标值和格式。</p>
<p>将设置四行改为</p>
<pre><code class="python">        axis.set_major_locator(NullLocator())
        axis.set_major_formatter(NullFormatter())
        axis.set_minor_locator(NullLocator())
        axis.set_minor_formatter(NullFormatter())
</code></pre>
<p>可以发现，<code>plt.show()</code> 没有了水平刻度值，也没有警告信息。</p>
<p>通过观察可知，<code>set_major_XXX</code> 控制刻度值，而<code>set_minor_XXX</code> 控制刻度格。</p>
<p>并且错误原因在于<code>axis.set_major_formatter(LogFormatterSciNotation(self.base))</code> 。</p>
<p>因为 <code>LogScale</code> 默认以 10 为底（<code>self.base</code> ），因此可知该句等价于</p>
<p><code>Axis.set_major_formatter(LogFormatterSciNotation(10))</code></p>
<p>其中，<code>LogFormatterSciNotation</code> 类型为 <code>matplotlib.ticker.LogFormatterSciNotation</code> 。</p>
<hr>
<p>根据输出的警告信息，我们在对应位置前生成一个异常，可以得到</p>
<pre><code class="python">matplotlib\mathtext.py in __init__(self, c, state, math)
   1454         # The real width, height and depth will be set during the
   1455         # pack phase, after we know the real fontsize
-&gt; 1456         self._update_metrics()
   1457 
   1458     def __internal_repr__(self):

matplotlib\mathtext.py in _update_metrics(self)
   1461     def _update_metrics(self):
   1462         metrics = self._metrics = self.font_output.get_metrics(
-&gt; 1463             self.font, self.font_class, self.c, self.fontsize, self.dpi, self.math)
   1464         if self.c == &#39; &#39;:
   1465             self.width = metrics.advance

matplotlib\mathtext.py in get_metrics(self, font, font_class, sym, fontsize, dpi, math)
    456             &quot;height&quot;.
    457         &quot;&quot;&quot;&quot;&quot;&quot;&quot; # 为了不影响代码高亮，补全引号
--&gt; 458         info = self._get_info(font, font_class, sym, fontsize, dpi, math)
    459         return info.metrics
    460 

matplotlib\mathtext.py in _get_info(self, fontname, font_class, sym, fontsize, dpi, math)
    579 
    580         font, num, symbol_name, fontsize, slanted = \
--&gt; 581             self._get_glyph(fontname, font_class, sym, fontsize, math)
    582 
    583         font.set_size(fontsize, dpi)

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    907             # otherwise return regular glyph
    908             return super(DejaVuFonts, self).\_get_glyph(fontname,
--&gt; 909                     font_class, sym, fontsize, math)
    910 
    911 

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    787 
    788     def _get_glyph(self, fontname, font_class, sym, fontsize, math=True):
--&gt; 789         raise &quot;test&quot;
    790         found_symbol = False
    791 
</code></pre>
<p>此时的 fontname 为 ‘default’，应当改为其他内容（以满足条件 <code>fontname in (&#39;it&#39;, &#39;regular&#39;)</code> ）</p>
<hr>
<p>经测试，改 UnicodeFonts 类中 _get_glyph 内 fontname 为 ‘it’ 可解决问题。</p>
<p>经测试，改 TruetypeFonts 类中 _get_info 方法的 fontname 为 ‘it’ 也可解决问题。</p>
<p>经测试，改 Fonts 基类中的 get_metrics 方法的 font 为 ‘it’ 无效。</p>
<p>在 _get_info 添加输出，可以发现其被多处调用。</p>
<p>重新获取另一调用链，可得</p>
<pre><code class="python">matplotlib\mathtext.py in group(self, s, loc, toks)
   2814 
   2815     def group(self, s, loc, toks):
-&gt; 2816         grp = Hlist(toks[0])
   2817         return [grp]
   2818     required_group = simple_group = group

matplotlib\mathtext.py in __init__(self, elements, w, m, do_kern)
   1609         List.__init__(self, elements)
   1610         if do_kern:
-&gt; 1611             self.kern()
   1612         self.hpack()
   1613 

matplotlib\mathtext.py in kern(self)
   1631 
   1632                 new_children.append(elem)
-&gt; 1633                 kerning_distance = elem.get_kerning(next)
   1634                 if kerning_distance != 0.:
   1635                     kern = Kern(kerning_distance)

matplotlib\mathtext.py in get_kerning(self, next)
   1486                 self.font, self.font_class, self.c, self.fontsize,
   1487                 next.font, next.font_class, next.c, next.fontsize,
-&gt; 1488                 self.dpi)
   1489         return advance + kern
   1490 

matplotlib\mathtext.py in get_kern(self, font1, fontclass1, sym1, fontsize1, font2, fontclass2, sym2, fontsize2, dpi)
    634                  font2, fontclass2, sym2, fontsize2, dpi):
    635         if font1 == font2 and fontsize1 == fontsize2:
--&gt; 636             info1 = self._get_info(font1, fontclass1, sym1, fontsize1, dpi)
    637             info2 = self._get_info(font2, fontclass2, sym2, fontsize2, dpi)
    638             font = info1.font

matplotlib\mathtext.py in _get_info(self, fontname, font_class, sym, fontsize, dpi, math)
    580 
    581         font, num, symbol_name, fontsize, slanted = \
--&gt; 582             self._get_glyph(fontname, font_class, sym, fontsize, math)
    583 
    584         font.set_size(fontsize, dpi)

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    909             # otherwise return regular glyph
    910             return super(DejaVuFonts, self)._get_glyph(fontname,
--&gt; 911                     font_class, sym, fontsize, math)
    912 
    913 

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    840                 else:
    841                     return self.cm_fallback._get_glyph(
--&gt; 842                         fontname, font_class, sym, fontsize)
    843             else:
    844                 if fontname in (&#39;it&#39;, &#39;regular&#39;) and isinstance(self, StixFonts):

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    845                     return self._get_glyph(&#39;rm&#39;, font_class, sym, fontsize)
    846                 print(fontname)
--&gt; 847                 raise &#39;error&#39;
    848                 warn(&quot;Font &#39;%s&#39; does not have a glyph for &#39;%s&#39; [U+%x]&quot; %
    849                      (new_fontname,
</code></pre>
<p>为了方便此后调试，在改动部分加上 <code># RecoDebugging</code> 。</p>
<p>该次 Bug 出错在于 <code>mathtext.Char.font = &#39;default&#39;</code> ，经过捕捉可发现其被 <code>state.font</code> 赋值，即 <code>matplotlib.mathtext.Parser.State.font</code> 。</p>
<p>追踪这个构造函数调用，可得</p>
<pre><code class="python">matplotlib\mathtext.py in symbol(self, s, loc, toks)
   2638         c = toks[0]
   2639         try:
-&gt; 2640             char = Char(c, self.get_state())
   2641         except ValueError:
   2642             raise ParseFatalException(s, loc, &quot;Unknown symbol: %s&quot; % c)

matplotlib\mathtext.py in __init__(self, c, state, math)
   1449         self.c = c
   1450         self.font_output = state.font_output
-&gt; 1451         raise &#39;test&#39;
   1452         self.font = state.font
   1453         self.font_class = state.font_class
</code></pre>
<p>观察 <code>matplotlib.mathtext.Parser.symbol</code> 可得，<code>Parser.State</code> 构造函数被调用于 </p>
<pre><code class="python">matplotlib\mathtext.py in parse(self, s, fonts_object, fontsize, dpi)
   2513         Returns the parse tree of :class:`Node` instances.
   2514         &quot;&quot;&quot;&quot;&quot;&quot; # end the comment
-&gt; 2515         self._state_stack = [self.State(fonts_object, &#39;default&#39;, &#39;rm&#39;, fontsize, dpi)]
   2516         self._em_width_cache = &#123;&#125;
   2517         try:

C:\ProgramData\Anaconda3\lib\site-packages\matplotlib\mathtext.py in __init__(self, font_output, font, font_class, fontsize, dpi)
   2540         &quot;&quot;&quot;&quot;&quot;&quot;  # end the comment
   2541         def __init__(self, font_output, font, font_class, fontsize, dpi):
-&gt; 2542             raise &#39;generate state&#39;
   2543             self.font_output = font_output
   2544             self._font = font
</code></pre>
<p>最终可以发现，<code>state</code> 被赋值于此处，只需要修改 <code>matplotlib.mathtext.Parser.parse</code> 即可结束此支错误。</p>
<hr>
<p>暂改为 ‘it’，运行仍然出错，主动抛出异常，捕获链如下：</p>
<pre><code class="python">matplotlib\mathtext.py in group(self, s, loc, toks)
   2815 
   2816     def group(self, s, loc, toks):
-&gt; 2817         grp = Hlist(toks[0])
   2818         return [grp]
   2819     required_group = simple_group = group

matplotlib\mathtext.py in __init__(self, elements, w, m, do_kern)
   1609         List.__init__(self, elements)
   1610         if do_kern:
-&gt; 1611             self.kern()
   1612         self.hpack()
   1613 

matplotlib\mathtext.py in kern(self)
   1631 
   1632                 new_children.append(elem)
-&gt; 1633                 kerning_distance = elem.get_kerning(next)
   1634                 if kerning_distance != 0.:
   1635                     kern = Kern(kerning_distance)

matplotlib\mathtext.py in get_kerning(self, next)
   1486                 self.font, self.font_class, self.c, self.fontsize,
   1487                 next.font, next.font_class, next.c, next.fontsize,
-&gt; 1488                 self.dpi)
   1489         return advance + kern
   1490 

matplotlib\mathtext.py in get_kern(self, font1, fontclass1, sym1, fontsize1, font2, fontclass2, sym2, fontsize2, dpi)
    634                  font2, fontclass2, sym2, fontsize2, dpi):
    635         if font1 == font2 and fontsize1 == fontsize2:
--&gt; 636             info1 = self._get_info(font1, fontclass1, sym1, fontsize1, dpi)
    637             info2 = self._get_info(font2, fontclass2, sym2, fontsize2, dpi)
    638             font = info1.font

matplotlib\mathtext.py in _get_info(self, fontname, font_class, sym, fontsize, dpi, math)
    580 
    581         font, num, symbol_name, fontsize, slanted = \
--&gt; 582             self._get_glyph(fontname, font_class, sym, fontsize, math)
    583 
    584         font.set_size(fontsize, dpi)

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    909             # otherwise return regular glyph
    910             return super(DejaVuFonts, self)._get_glyph(fontname,
--&gt; 911                     font_class, sym, fontsize, math)
    912 
    913 

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    840                 else:
    841                     return self.cm_fallback._get_glyph(
--&gt; 842                         fontname, font_class, sym, fontsize)
    843             else:
    844                 if fontname in (&#39;it&#39;, &#39;regular&#39;) and isinstance(self, StixFonts):

matplotlib\mathtext.py in _get_glyph(self, fontname, font_class, sym, fontsize, math)
    845                     return self._get_glyph(&#39;rm&#39;, font_class, sym, fontsize)
    846                 #print(fontname)
--&gt; 847                 raise &#39;error&#39; # RecoDebugging
    848                 warn(&quot;Font &#39;%s&#39; does not have a glyph for &#39;%s&#39; [U+%x]&quot; %
    849                      (new_fontname,
</code></pre>

  </article>

  
      
    <div class="chireiden-post-copyright">
        <strong>本文作者：</strong>RedContritio<br>
        <strong>本文链接：</strong><a href="https://redcontritio.github.io/2019/11/07/matplotlib%E7%BC%96%E7%A0%81%E5%AD%97%E4%BD%93%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B/" title="https:&#x2F;&#x2F;redcontritio.github.io&#x2F;2019&#x2F;11&#x2F;07&#x2F;matplotlib%E7%BC%96%E7%A0%81%E5%AD%97%E4%BD%93%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;redcontritio.github.io&#x2F;2019&#x2F;11&#x2F;07&#x2F;matplotlib%E7%BC%96%E7%A0%81%E5%AD%97%E4%BD%93%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="chireiden-post-meta chireiden-rainbow">
    
    
        <a class="chireidenfont icon-tag-fill -none-link" href="/tags/python-matplotlib/" rel="tag">python matplotlib</a>
    
</div>

  
      <div class="chireiden-post-footer">
          <section class="chireiden-comment">
    <div id="gitment"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
    owner: 'RedContritio', // 你的 GitHub ID
    repo: 'RedContritio.github.io', // 存储评论的 repo
    oauth: {
        client_id: '80b2453b6d5f37ad6225', // 你的 client ID
        client_secret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb' // 你的 client secret
    },
})
gitment.render('gitment')
</script>
</section>
      </div>
  
</div>
            <div class="chireiden-post-right">
              <div class="chireiden-fixed">
                  <div class="chireiden-tool"> 
                    
                      
                    
                      <a href="#chireiden-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="chireidenfont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="chireiden-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    
<script src="/lib/mdui_043tiny/mdui.js"></script>
<script src="/lib/jquery.min.js"></script>
<script src="/lib/justifiedGallery/jquery.justifiedGallery.min.js"></script>
<script src="/lib/fancybox/fancybox.umd.js"></script>


 

<script async src="/js/app.js?v=1675841852990"></script>



<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
