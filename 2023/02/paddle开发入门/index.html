<!doctype html><head><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><title>Paddle开发入门 - Chireiden</title><meta name=author content="RedContritio"><meta name=description content="地霊殿，充满幻想与希望的殿堂"><meta property="og:title" content="Paddle开发入门"><meta property="og:description" content="过年期间看到 Paddle 框架那边发了新的 issue，所以顺手修了几个，这里取几个例子来简单介绍其修复过程，"><meta property="og:type" content="article"><meta property="og:url" content="https://RedContritio.github.io/2023/02/paddle%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-08T17:02:29+08:00"><meta property="article:modified_time" content="2023-02-08T17:02:29+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Paddle开发入门"><meta name=twitter:description content="过年期间看到 Paddle 框架那边发了新的 issue，所以顺手修了几个，这里取几个例子来简单介绍其修复过程，"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<link rel=stylesheet href=https://RedContritio.github.io/scss/main.min.7eb360f545dea4e461c361ba2b40f8b68bf2f8129d711aab867c8748ca5a8c07.css integrity="sha256-frNg9UXepORhw2G6K0D4tovy+BKdcRqrhnyHSMpajAc=" crossorigin=anonymous media=screen><link href=//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css rel=stylesheet></head></head><body><span class="mobile btn-mobile-menu"><i class="fa fa-list btn-mobile-menu__icon"></i>
<i class="fa fa-angle-up btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed" style=background-image:url(/images/background-cover.jpg)><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><a href=/#blog title="Homepage of Chireiden " class=blog-button><img src=/images/avatar.jpg width=80 alt="Chireiden logo" class="panel-cover__logo logo"></a><h1 class="panel-cover__title panel-title"><a href=/#blog title="Homepage of Chireiden" class=blog-button>Chireiden</a></h1><span class="panel-cover__subtitle panel-subtitle">地霊殿</span><hr class=panel-cover__divider><p class=panel-cover__description>地霊殿，充满幻想与希望的殿堂</p><hr class="panel-cover__divider panel-cover__divider--secondary"><p class=panel-cover__description>夢も希望も無い、毎日がそんな生活だった。</p><div class=navigation-wrapper><div><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=/#blog title=Blog class=blog-button>Blog</a></li><li class=navigation__item><a href=/tags/ target=_blank title=Tags>Tags</a></li><li class=navigation__item><a href=/friends/ target=_blank title=Friends>Friends</a></li><li class=navigation__item><a href=/about/ target=_blank title=About>About</a></li></ul></nav></div><div><nav class="cover-navigation navigation--social"><ul class=navigation><li class=navigation__item><a href=https://github.com/RedContritio title=@RedContritio target=_blank><i class='social fa fa-github'></i>
<span class=label>Github</span></a></li><li class=navigation__item><a href=/index.xml rel=author title=RSS target=_blank><i class='social fa fa-rss'></i>
<span class=label>RSS</span></a></li><li class=navigation__item><a href=mailto:RedContritio@qq.com title="Contact me"><i class='social fa fa-envelope'></i>
<span class=label>Email</span></a></li></ul></nav></div></div></div></div><div class="panel-cover--overlay cover-light-red"></div></div></header><div class=content-wrapper><div class=content-wrapper__inner><article class="post-container post-container--single" itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><div class=post-meta><time datetime=" 2023-02-08 17:02:29 +0800 " itemprop=datePublished class="post-meta__date date">2023-02-08</time></div><h1 class=post-title>Paddle开发入门</h1></header><section class=post><nav id=TableOfContents><ul><li><a href=#paddleflip>paddle.flip</a></li></ul></nav><p>过年期间看到 Paddle 框架那边发了新的 issue，所以顺手修了几个，这里取几个例子来简单介绍其修复过程，</p><h2 id=paddleflip>paddle.flip</h2><p>事实上的首个动手目标，它的出错输入是这样的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> paddle
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> paddle <span style=color:#f92672>import</span> flip
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>to_tensor(np<span style=color:#f92672>.</span>random<span style=color:#f92672>.</span>uniform(<span style=color:#f92672>-</span><span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>, [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>])<span style=color:#f92672>.</span>astype(np<span style=color:#f92672>.</span>int64)),
</span></span><span style=display:flex><span>axis <span style=color:#f92672>=</span> paddle<span style=color:#f92672>.</span>to_tensor(np<span style=color:#f92672>.</span>random<span style=color:#f92672>.</span>uniform(<span style=color:#f92672>-</span><span style=color:#ae81ff>2147483648</span>, <span style=color:#ae81ff>2147483647</span>, [<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>])<span style=color:#f92672>.</span>astype(np<span style=color:#f92672>.</span>int32))
</span></span><span style=display:flex><span>print(x)
</span></span><span style=display:flex><span>print(axis)
</span></span><span style=display:flex><span>flip(x, axis)
</span></span></code></pre></div><p>翻到 Paddle 源码看看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>flip</span>(x, axis, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Reverse the order of a n-D tensor along given axis in axis.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Args:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        x (Tensor): A Tensor(or LoDTensor) with shape :math:`[N_1, N_2,..., N_k]` . The data type of the input Tensor x
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            should be float32, float64, int32, int64, bool.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        axis (list|tuple|int): The axis(axes) to flip on. Negative indices for indexing from the end are accepted.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        name (str, optional): Name for the operation (optional, default is None). For more information, please refer to :ref:`api_guide_Name`.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Returns:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Tensor, Tensor or LoDTensor calculated by flip layer. The data type is same with input x.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Examples:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        .. code-block:: python
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          import paddle
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          image_shape=(3, 2, 2)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          img = paddle.arange(image_shape[0] * image_shape[1] * image_shape[2]).reshape(image_shape)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          tmp = paddle.flip(img, [0,1])
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          print(tmp) # [[[10,11],[8, 9]], [[6, 7],[4, 5]], [[2, 3],[0, 1]]]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          out = paddle.flip(tmp,-1)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          print(out) # [[[11,10],[9, 8]], [[7, 6],[5, 4]], [[3, 2],[1, 0]]]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isinstance(axis, int):
</span></span><span style=display:flex><span>        axis <span style=color:#f92672>=</span> [axis]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> in_dygraph_mode():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _C_ops<span style=color:#f92672>.</span>flip(x, axis)
</span></span></code></pre></div><p>思路很明显，flip 期望输入一个一维的数组，但是错误的案例里输入了二维的。因此解决方案就更明显了，不妨加一个维度检查。</p><p>加在哪呢？很直观的，既然上面的 python 代码里处理了输入单个整数时将其转换为整数，那就给它加上一个维度检查，形如</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>if</span> paddle<span style=color:#f92672>.</span>to_tensor(axis)<span style=color:#f92672>.</span>ndim <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;维度不对，麻烦再检查检查，只要一维的&#39;</span>)
</span></span></code></pre></div><p>非常合理，而且简单易懂，维度不为 1 就报错，于是事情就这样成了（并没有）。</p><p>因为 <a href=https://github.com/PaddlePaddle/Paddle/issues/49927>Good First Issue Lists</a> 里面还有这样的对话。</p><blockquote><blockquote><p>您好，想问下是要在 Python 端加输入检查，还是要在C++端用 <code>PADDLE_ENFORCE_EQ</code> 做检查呢 ?</p></blockquote><p>根据情况而定。能够在C++端加的，一定要在C++端加。如果C++端不具备条件的，则在Python端加。</p></blockquote><p>也就是说，应该尽可能在 C++ 端加对应检查。</p><p>C++ 端加检查难吗？不难，顺着 flip 查找内核实现，就能看到 <code>flip_kernel.cc</code> 里面对应的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T, <span style=color:#66d9ef>typename</span> Context<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> FlipKernel(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> dev_ctx,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> DenseTensor<span style=color:#f92672>&amp;</span> x,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;&amp;</span> axis,
</span></span><span style=display:flex><span>                DenseTensor<span style=color:#f92672>*</span> out);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PD_REGISTER_KERNEL(flip,
</span></span><span style=display:flex><span>                   CPU,
</span></span><span style=display:flex><span>                   ALL_LAYOUT,
</span></span><span style=display:flex><span>                   phi<span style=color:#f92672>::</span>FlipKernel,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>float</span>,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>double</span>,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>int32_t</span>,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>int64_t</span>,
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>                   phi<span style=color:#f92672>::</span>dtype<span style=color:#f92672>::</span>complex<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>                   phi<span style=color:#f92672>::</span>dtype<span style=color:#f92672>::</span>complex<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>double</span><span style=color:#f92672>&gt;</span>) {}
</span></span></code></pre></div><p>也就是说，只要看 <code>FlipKernel</code> 就行了。</p><p>逻辑很合理，但是失败了，gdb 调试跑了一遍（gdb 7 支持了 python 调试），看到了和 <strong>#49922</strong> 相同的调用栈。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AddressSanitizer:DEADLYSIGNAL
</span></span><span style=display:flex><span><span style=color:#f92672>=================================================================</span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>92083</span><span style=color:#f92672>==</span>ERROR: AddressSanitizer: SEGV on unknown address <span style=color:#ae81ff>0x000000000008</span> (pc <span style=color:#ae81ff>0x7faceb79eab3</span> bp <span style=color:#ae81ff>0x7ffe95a59990</span> sp <span style=color:#ae81ff>0x7ffe95a598e0</span> T0)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>92083</span><span style=color:#f92672>==</span>The signal is caused by a READ memory access.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>92083</span><span style=color:#f92672>==</span>Hint: address points to the zero page.
</span></span><span style=display:flex><span>    <span style=color:#75715e>#0 0x7faceb79eab3 in paddle::pybind::PyObject_CheckLongOrToLong(_object**) /home/work/yakun/paddle-2.4.0/Paddle/paddle/fluid/pybind/op_function_common.cc:69:8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#1 0x7faceb7a4dd5 in paddle::pybind::CastPyArg2Ints(_object*, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, long) /home/work/yakun/paddle-2.4.0/Paddle/paddle/fluid/pybind/op_function_common.cc:357:11
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#2 0x7facea7c4caf in paddle::pybind::eager_api_flip(_object*, _object*, _object*) /home/work/yakun/paddle-2.4.0/Paddle/paddle/fluid/pybind/eager_op_function.cc:1216:29
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#3 0x5025f3 in PyCFunction_Call (/usr/bin/python3.8+0x5025f3) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#4 0x500db4 in _PyObject_MakeTpCall (/usr/bin/python3.8+0x500db4) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#5 0x566223 in _PyEval_EvalFrameDefault (/usr/bin/python3.8+0x566223) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#6 0x55f470 in _PyEval_EvalCodeWithName (/usr/bin/python3.8+0x55f470) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#7 0x5016c5 in _PyFunction_Vectorcall (/usr/bin/python3.8+0x5016c5) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#8 0x560136 in _PyEval_EvalFrameDefault (/usr/bin/python3.8+0x560136) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#9 0x55f470 in _PyEval_EvalCodeWithName (/usr/bin/python3.8+0x55f470) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#10 0x55f102 in PyEval_EvalCode (/usr/bin/python3.8+0x55f102) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#11 0x62a1ef  (/usr/bin/python3.8+0x62a1ef) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#12 0x62a179  (/usr/bin/python3.8+0x62a179) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#13 0x47a7f2  (/usr/bin/python3.8+0x47a7f2) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#14 0x47a5cb in PyRun_SimpleFileExFlags (/usr/bin/python3.8+0x47a5cb) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#15 0x4247dc in _init (/usr/bin/python3.8+0x4247dc) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#16 0x5fb9b8 in Py_BytesMain (/usr/bin/python3.8+0x5fb9b8) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#17 0x7fad0bf9783f in __libc_start_main /build/glibc-S7Ft5T/glibc-2.23/csu/../csu/libc-start.c:291
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#18 0x5fb8b8 in _start (/usr/bin/python3.8+0x5fb8b8) (BuildId: 69b06f9a4b2e8428d7e32aa682c34a91dc0b961e)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>AddressSanitizer can not provide additional info.
</span></span><span style=display:flex><span>SUMMARY: AddressSanitizer: SEGV <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>work<span style=color:#f92672>/</span>yakun<span style=color:#f92672>/</span>paddle<span style=color:#f92672>-</span><span style=color:#ae81ff>2.4.0</span><span style=color:#f92672>/</span>Paddle<span style=color:#f92672>/</span>paddle<span style=color:#f92672>/</span>fluid<span style=color:#f92672>/</span>pybind<span style=color:#f92672>/</span>op_function_common.cc:<span style=color:#ae81ff>69</span><span style=color:#f92672>:</span><span style=color:#ae81ff>8</span> in paddle<span style=color:#f92672>::</span>pybind<span style=color:#f92672>::</span>PyObject_CheckLongOrToLong(_object<span style=color:#f92672>**</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>92083</span><span style=color:#f92672>==</span>ABORTING
</span></span></code></pre></div><p>可以看到，调用栈完全没进入到 <code>FlipKernel</code> 中，而是停在了 <code>eager_api_flip</code>，这个自动生成的文件里，并且更具体的，是 <code>CastPyArg2Ints</code> 这个函数。</p><p>这个函数简单来说，是将类型为 <code>PyObject</code> 的 <code>python</code> 变量转换成 <code>std::vector&lt;int></code> 的 <code>cpp</code> 值，首先判断输入变量是否可迭代，如果可迭代，就将每个元素转换为 <code>int</code>（<code>long</code>）。</p><p>而问题就出在这个转换过程：先检查是否能转换为 <code>long</code>，如果能，则进行转换，否则抛出错误。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>PyObject_CheckLongOrToLong</span>(PyObject<span style=color:#f92672>**</span> obj) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ((PyLong_Check(<span style=color:#f92672>*</span>obj) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>PyBool_Check(<span style=color:#f92672>*</span>obj)) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>      PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)g_vartype_pytype) <span style=color:#f92672>||</span>  <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)g_varbase_pytype) <span style=color:#f92672>||</span>  <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)p_tensor_type)) {     <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>如果 <code>obj</code> 是（能转换到） <code>long</code> 并且 <code>obj</code> 不是 <code>bool</code>，则返回 <code>true</code>。
<strong>或者，如果 <code>obj</code> 是 <code>Variable</code> 或 <code>Tensor</code>，返回 <code>true</code></strong>。</p><ul><li>当 <code>item</code> 为 <code>long</code> 的时候<ul><li>检查能否转换 <code>PyObject_CheckLongOrToLong</code> 结果为 <code>true</code>, 检查通过</li><li>进行 <code>PyLong_AsLong</code>，<strong>得到一个 long 变量的指针</strong></li></ul></li><li>当 <code>item</code> 为 tensor 的时候<ul><li>检查能否转换 <code>PyObject_CheckLongOrToLong</code> 结果为 true（不确定内部逻辑通过原因）, 检查通过</li><li>进行 <code>PyLong_AsLong</code>，<strong>得到一个空指针</strong></li></ul></li></ul><p>因而出错。</p><p>简单来说，<code>PyObject_CheckLongOrToLong</code> 对 <code>Variable</code> 和 <code>Tensor</code> 这种复杂类型的检查，不够详尽。</p><p>最后进行的修复策略也同样简单。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ((PyLong_Check(<span style=color:#f92672>*</span>obj) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>PyBool_Check(<span style=color:#f92672>*</span>obj)) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>      PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)g_vartype_pytype) <span style=color:#f92672>||</span>  <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)g_varbase_pytype) <span style=color:#f92672>||</span>  <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)p_tensor_type)) {     <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      (PyObject_IsInstance(<span style=color:#f92672>*</span>obj, (PyObject<span style=color:#f92672>*</span>)p_tensor_type) <span style=color:#f92672>&amp;&amp;</span>    <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       (((TensorObject<span style=color:#f92672>*</span>)(<span style=color:#f92672>*</span>obj))<span style=color:#f92672>-&gt;</span>tensor.numel() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>))) {        <span style=color:#75715e>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>即检查是否是仅存在单个元素，如果是，则表明其支持转换。</p><p>通过添加该检查，能够解决该问题。</p><p>但是通过敏锐的观察力，不难发现，对于其他数据类型，如 <code>float</code> 等，同样存在该问题。</p><p>同时，也不难发现，对于 <code>Variable</code> (<code>static</code>)，同样存在该问题。</p><p>因此短期小目标是对这些检查代码进行修改，以提高其稳健性。</p></section></article><section class=read-more><div class=read-more-header><div class="read-more-header-item read-more-item"><span class=read-more-item-dim>Recent</span><h2 class="post-list__post-title post-title"><a href=/2023/02/%E5%9B%BD%E5%86%85git%E5%8A%A0%E9%80%9F/ title="link to 国内git加速">国内git加速</a></h2></div><div class="read-more-header-item read-more-item"><span class=read-more-item-dim>Earlier</span><h2 class="post-list__post-title post-title"><a href=/2021/11/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%B5%84%E8%B4%A8%E5%B9%B3%E5%B9%B3%E4%B9%9F%E8%A6%81%E5%AF%BB%E4%BB%99%E9%97%AE%E9%81%93/ title="link to 编程通解 第一章 资质平平也要寻仙问道">编程通解 第一章 资质平平也要寻仙问道</a></h2></div></div><div class=read-more-summary><div class="read-more-summary-item read-more-item"><p class=excerpt><p>一步式操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git config --global url.<span style=color:#e6db74>&#34;https://ghproxy.com/https://github.com/&#34;</span>.insteadOf <span style=color:#e6db74>&#34;https://github.com/&#34;</span>
</span></span><span style=display:flex><span>git config --global protocol.https.allow always
</span></span></code></pre></div>&mldr;</p></div><div class="read-more-summary-item read-more-item"><p class=excerpt><p>竹林里站着一个孩子，十来岁的孩子。</p><p>他什么也没做，只是站着，盯着竹子，满脸的愤懑。</p><p>他所在的竹林在陈家后山上，外人不得入内，所以，他自然也是陈家的人。</p><p>可惜，他的七品资质，在寻常人家里，能让邻里人前人后议论数月不止的七品资质，却让他快要做不了陈家的人了。</p>&mldr;</p></div></div><div class=read-more-meta><div class="read-more-meta-item read-more-item"><time datetime="2023-02-08 17:02:29 +0800" class="post-list__meta--date date">2023-02-11</time>
<a class=btn-border-small href=/2023/02/%E5%9B%BD%E5%86%85git%E5%8A%A0%E9%80%9F/>Continue</a></div><div class="read-more-meta-item read-more-item"><time datetime="2023-02-08 17:02:29 +0800" class="post-list__meta--date date">2021-11-12</time>
<span class="post-list__meta--tags tags">• <a href=https://RedContritio.github.io/tags/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3>编程通解</a> • <a href=https://RedContritio.github.io/tags/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3>编程思想</a> • <a href=https://RedContritio.github.io/tags/%E5%B0%8F%E8%AF%B4>小说</a></span>
<a class=btn-border-small href=/2021/11/%E7%BC%96%E7%A8%8B%E9%80%9A%E8%A7%A3-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%B5%84%E8%B4%A8%E5%B9%B3%E5%B9%B3%E4%B9%9F%E8%A6%81%E5%AF%BB%E4%BB%99%E9%97%AE%E9%81%93/>Continue</a></div></div></section><section class=post-comments><div id=gitalk-container><script>var gitalk=new Gitalk({clientID:"0a6a884a25f2cfcd11b3",clientSecret:"63fa88190fa69c3d00d744d99b78af1b13f595ec",repo:"RedContritio.github.io",owner:"RedContritio",admin:["RedContritio"],id:"76dfc227e3f8b0ebff8943660aa3db96_2023-02-08",distractionFreeMode:!1});gitalk.render("gitalk-container")</script></div></section><section class=footer><footer><span class=footer__copyright>This site is licensed under a <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> license.</span>
<span class=footer__copyright>Generated by <a href=https://gohugo.io/>Hugo</a> at 2024-12-04, themed with <a href=https://github.com/xslingcn/vno-hugo>Vno - Hugo</a>.</span></footer></section></div></div><script type=text/javascript src=//code.jquery.com/jquery-1.11.3.min.js></script>
<script type=text/javascript src=/js/main.js></script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","your_ga_id","your_host"),ga("send","pageview")</script></body>